# Copyright (c) 2025 The BFE Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

apiVersion: v1
kind: ServiceAccount
metadata:
  name: bfe-service-controller
  labels:
    app.kubernetes.io/name: bfe-service-controller
    app.kubernetes.io/instance: bfe-service-controller

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  #namespace as postfix
  name: bfe-service-controller-default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: bfe-service-controller
  namespace: bfe-system

---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: bfe-service-controller
  labels:
    app.kubernetes.io/name: bfe-service-controller
    app.kubernetes.io/instance: bfe-service-controller
spec:
  replicas: 1
  strategy:
    type: Recreate 
  selector:
    matchLabels:
      app.kubernetes.io/name: bfe-service-controller
      app.kubernetes.io/instance: bfe-service-controller
  template:
    metadata:
      labels:
        app.kubernetes.io/name: bfe-service-controller
        app.kubernetes.io/instance: bfe-service-controller
    spec:
      serviceAccountName: bfe-service-controller
      containers:
        - name: bfe-service-controller
          imagePullPolicy: Always
          image: ghcr.io/bfenetworks/service-controller:latest
          command: [ "/service-controller" ]
          args:
            - '-bfe-api-addr=http://api-server.bfe-system.svc.cluster.local:8183'
            - '-bfe-api-token=Token eT5QWkLhQmp6lO4NWxAc'
            - '-k8s-cluster-name=szyf'
            - '-namespace=default'
          ports:
            - containerPort: 9081
          livenessProbe:
            httpGet:
              path: /healthz
              port: 9081
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 2
            successThreshold: 1
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /readyz
              port: 9081
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 2
            successThreshold: 1
            failureThreshold: 3
          securityContext:
            runAsUser: 1000       # bfeuser defined in Dockerfile
            runAsGroup: 1000      # bfegroup defined in Dockerfile
            runAsNonRoot: true            
            privileged: false
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
            readOnlyRootFilesystem: true
          resources:
            requests:
              cpu: "500m"     
              memory: "500Mi"   
            limits:
              cpu: "1"       
              memory: "2Gi"   
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: var-run
              mountPath: /var/run
      volumes:
        - name: tmp
          emptyDir: {}
        - name: var-run
          emptyDir: {}