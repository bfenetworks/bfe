# mod_body_process
## Module Overview

mod_body_process provides a streaming body processing framework. In many scenarios, the request or response body is streamed, such as SSE. For streaming data, if processing is required (e.g., content review), it cannot be cached and processed as a whole; instead, it must be processed chunk by chunk in real time as it is received.

Within this streaming processing framework, body data goes through three steps:
* decoder    - Parses received data into events in real time
* processors - A sequence of event processors. Each processor transforms input events into output events and can terminate the process by reporting errors. Events generated by the decoder are processed sequentially by the event processor chain
* encoder    - Re-encodes events into body data

Users can customize the processing flow for request or response bodies via configuration rules. Supported components include:
### decoder
* line - Parses data line by line, each line as an event
* json - Parses JSON objects from data, each JSON object as an event
* sse  - Parses SSE events from data
* default  - Automatically selects decoder based on contentType
### processor
* textfilter - Calls the ToolGood.TextFilter service for content review
### encoder
* default  - Directly calls the event's ToBytes() function to generate body data

## Basic Configuration

### Configuration Description

Module config file: conf/mod_body_process/mod_body_process.conf

| Option              | Description                                        |
| ------------------- | ------------------------------------------------- |
| Basic.ProductRulePath      | String<br>Path to the rule config file |
| Log.OpenDebug       | Boolean<br>Enable debug logs<br>Default: False |

### Configuration Example

```ini
[basic]
ProductRulePath = ../data/mod_body_process/body_process_rule.data

[log]
OpenDebug = false
```

## Rule Configuration

### Configuration Description

| Option                | Description                                        |
| --------------------- | ------------------------------------------------- |
| Version | String<br>Config file version |
| Config | Object<br>API-key authentication rule config for all product lines |
| Config{k} | String<br>Product line name|
| Config{v} | Array<br> API-key authentication rule list for the product line |
| Config{v}[] | Object<br> API-key authentication rule |
| Config{v}[].Cond | String<br>Matching condition, syntax see [Condition](../../condition/condition_grammar.md) |
| Config{v}[].RequestProcess | Object<br>Request body processing flow config, see structure below |
| Config{v}[].ResponseProcess | Object<br>Response body processing flow config, see structure below |

Data structure for body processing flow config:
```
// Processing flow
struct {
    Dec  string     // decoder, uses default if not specified
    Enc  string     // encoder, uses default if not specified
    Proc []ProcConf // processor list
}
// ProcConf
struct {
    Name string     // processor name, currently only supports "textfilter"
    Params []string // processor parameter list. textfilter: Params[0] - ToolGood.TextFilter service URL
}
```

### Configuration Example

```json
{
    "Config": {
        "example_product": [
            {
                "Cond": "!req_body_json_in(\"model\", \"\", false)",
                "RequestProcess": {
                        "Proc": [ 
                                {"name":"textfilter", "params":["http://172.19.1.136:9191/api/"]} 
                        ]
                },
                "ResponseProcess": {
                        "Proc": [
                                {"name":"textfilter", "params":["http://172.19.1.136:9191/api/"]}
                        ]
                }
            }
        ]
    },
    "Version": "20190101000000"
}
```
